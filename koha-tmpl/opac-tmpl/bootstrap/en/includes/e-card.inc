[% USE raw %]
[% USE Asset %]
[% Asset.js("lib/JsBarcode.all.min.js") | $raw %]
<script defer>
    !function(){"use strict";class t{constructor({entryPoint:t,options:e={}}){this.options=e;const r=document.querySelector(".loggedinusername");if(!r)throw new Error("Cannot find logged in username element.");if(this.borrowernumber=r.getAttribute("data-borrowernumber"),!this.borrowernumber)throw new Error("Cannot find borrowernumber attribute.");this.entryPoint={ref:t,styles:"border: 2px solid rgba(0,0,0,0.1); border-radius: 12px; padding: 2em 1em; background-color: #fff; position: relative; width: 100%; z-index: 100;",mediaQuery:`@media only screen and (max-aspect-ratio: 1/1) { #${t.id} { transform: rotate(-90deg) translate(25%, -75%) !important; } }`},this.modalBackdrop={ref:void 0,styles:"display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 99;"},this.cardnumber=void 0}async getData(){try{const t=await fetch(`/api/v1/patrons/${this.borrowernumber}`);if(!t.ok)throw new Error("Failed to fetch patron data.");const{cardnumber:e}=await t.json();this.cardnumber=e}catch(t){throw new Error("Failed to get patron data.")}}style(){this.entryPoint.ref.setAttribute("style",this.entryPoint.styles),this.modalBackdrop.ref.setAttribute("style",this.modalBackdrop.styles)}bootstrapModalBackdrop(){this.entryPoint.ref.insertAdjacentHTML("afterend",'<div id="e-card-modal-backdrop"></div>'),this.modalBackdrop.ref=document.getElementById("e-card-modal-backdrop")}expand(t){"e-card"===t.target.id&&(this.modalBackdrop.ref.style.display="block",this.entryPoint.ref.insertAdjacentHTML("afterend",`<style id="e-card-media-queries">${this.entryPoint.mediaQuery}</style>`),this.entryPoint.ref.setAttribute("style",`${this.entryPoint.styles} position: fixed; top: 50%; left: 50%; width: 85.60mm; height: 53.98mm; transform: translate(-50%, -50%); background-color: white; box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1); `))}collapse(t){["e-card-modal-backdrop","e-card"].includes(t.target.id)&&(this.modalBackdrop.ref.style.display="none",document.getElementById("e-card-media-queries").remove(),this.entryPoint.ref.setAttribute("style",this.entryPoint.styles))}async render(){await this.getData(),this.cardnumber&&(this.bootstrapModalBackdrop(),this.style(),JsBarcode(this.entryPoint.ref,this.cardnumber,{format:this.options.format||"CODE39",width:2,height:55,displayValue:!0}),this.entryPoint.ref.addEventListener("click",(t=>this.expand(t))),this.entryPoint.ref.addEventListener("keyup",(t=>{"block"!==this.modalBackdrop.ref.style.display?["Enter","Space"].includes(t.code)&&this.expand(t):["Enter","Space","Escape"].includes(t.code)&&this.collapse(t)})),this.modalBackdrop.ref.addEventListener("click",(t=>this.collapse(t))))}}const e=document.getElementById("e-card"),{barcodeFormat:r}=e.dataset;if(e){new t({entryPoint:e,options:{format:r}}).render()}}();
</script>
